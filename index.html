<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPI Meeting Board</title>
    <meta name="description" content="A web application that visualizes the New Product Introduction (NPI) plan from a whiteboard.">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#FEFCE8">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone (for TSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom print styles to ensure proper rendering */
        @media print {
          body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            background: #fff !important;
            color: #000 !important;
            font-size: 10pt;
            margin: 0;
            padding: 0;
          }
          .no-print {
            display: none !important;
          }
          .print-container {
            box-shadow: none !important;
            border: none !important;
            padding: 1cm !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            backdrop-filter: none !important;
            background: transparent !important;
            border-radius: 0 !important;
          }
          .print-show {
            display: block !important;
            visibility: visible !important;
          }
          .shadow-md, .shadow-lg, .shadow-inner {
            box-shadow: none !important;
          }
          .border, .border-b, .border-amber-100, .border-amber-200 {
            border-color: #ccc !important;
          }
          h1, h2, h3 {
            page-break-after: avoid;
          }
          .print-break-before-page {
            break-before: page;
          }
          .print-break-inside-avoid {
            break-inside: avoid;
          }
          h1, h2, h3, h4 {
            color: #000 !important;
          }
          h2 {
            font-size: 16pt;
            border-color: #ccc !important;
          }
          h3 {
            font-size: 11pt;
          }
          p, li, td, th, span {
            font-size: 9pt;
          }
          .card-print-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
          }
          table {
            width: 100%;
          }
          .print-card {
            box-shadow: none !important;
            border: 1px solid #ccc !important;
            background: #fff !important;
            padding: 0.5rem !important;
          }
        }
    </style>
</head>
<body class="bg-amber-50 text-gray-900 dark:bg-slate-900 dark:text-slate-200 font-sans">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
// --- From types.ts ---
interface ProjectDetails {
  id: string;
  quantity: number;
  pcbSize: string;
  targetShipDate: string;
}

interface SpecDetails {
  id: string;
  title: string;
  items: Record<string, string | number>;
}

interface ProcessStep {
  id:string;
  name:string;
  details: string;
  type: 'process' | 'test' | 'qc' | 'pack';
  isActive: boolean;
  startDate: string;
  endDate: string;
  relatedSpecId?: string | null;
}

// --- From components/EditableField.tsx ---
const EditableField = ({
  initialValue,
  onSave,
  as: Component = 'span',
  className = '',
  inputClassName = '',
  type = 'text',
}) => {
  const { useState, useEffect, useRef } = React;
  const [isEditing, setIsEditing] = useState(false);
  const [value, setValue] = useState(String(initialValue));
  const inputRef = useRef(null);

  useEffect(() => {
    setValue(String(initialValue));
  }, [initialValue]);

  useEffect(() => {
    if (isEditing && inputRef.current) {
      inputRef.current.focus();
      if (inputRef.current instanceof HTMLInputElement) {
        inputRef.current.select();
      }
    }
  }, [isEditing]);

  const handleSave = () => {
    if (String(initialValue) !== value) {
      onSave(value);
    }
    setIsEditing(false);
  };
  
  const isTextarea = Component === 'div' || (typeof initialValue === 'string' && initialValue.includes('\n'));

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !isTextarea && type !== 'datetime-local') {
        e.preventDefault();
        handleSave();
    } else if (e.key === 'Escape') {
      setValue(String(initialValue));
      setIsEditing(false);
    }
  };

  if (isEditing) {
    const commonProps = {
        value: value,
        onChange: (e) => setValue(e.target.value),
        onBlur: handleSave,
        onKeyDown: handleKeyDown,
        className: `w-full h-full bg-white dark:bg-slate-900 outline-none focus:ring-2 focus:ring-amber-500 dark:focus:ring-amber-600 rounded-md ${inputClassName}`
    };

    if (isTextarea) {
      return (
        <textarea
          ref={inputRef}
          {...commonProps}
          rows={Math.max(3, String(value).split('\n').length + 1)}
        />
      );
    }

    return (
      <input
        ref={inputRef}
        type={type}
        {...commonProps}
      />
    );
  }
  
  const displayValue = (type === 'date' && typeof value === 'string' && value)
    ? value
    : (type === 'datetime-local' && typeof value === 'string' && value)
    ? value.replace('T', ' ')
    : value;

  return (
    <Component
      onDoubleClick={() => setIsEditing(true)}
      className={`${className} transition-colors cursor-pointer hover:bg-amber-100/50 dark:hover:bg-amber-500/10 rounded-md p-1 -m-1`}
      title="Double-click to edit"
      style={ isTextarea ? { whiteSpace: 'pre-wrap', minHeight: '1.5em' } : {}}
    >
      {displayValue || <span className="text-gray-400 dark:text-slate-500">(empty)</span>}
    </Component>
  );
};


// --- From components/Card.tsx ---
const Card = ({ title, children, className = '' }) => {
  return (
    <div className={`bg-white dark:bg-slate-700/50 p-4 rounded-lg shadow-md border border-amber-100 dark:border-slate-600 print:break-inside-avoid ${className}`}>
      <h3 className="text-sm font-medium text-gray-500 dark:text-slate-400">{title}</h3>
      {children}
    </div>
  );
};


// --- From components/Calendar.tsx ---
const Calendar = ({ events = [], onDateClick, selectedDate, showEvents = true }) => {
  const { useState } = React;
  const [currentDate, setCurrentDate] = useState(selectedDate || new Date());

  const handlePrevMonth = () => {
    setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
  };

  const handleNextMonth = () => {
    setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
  };

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const monthName = `${month + 1}月`;
  const firstDayOfMonth = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date();

  const isToday = (day) => {
    const d = new Date();
    return d.getDate() === day && d.getMonth() === month && d.getFullYear() === year;
  }
  
  const isEventDay = (day) => {
      if (!showEvents) return false;
      const checkDate = new Date(Date.UTC(year, month, day));
      return events.some(event => {
          if (!event.startDate) return false;
          try {
              const eventDate = new Date(event.startDate);
              const eventUTCDate = new Date(Date.UTC(eventDate.getUTCFullYear(), eventDate.getUTCMonth(), eventDate.getUTCDate()));
              return checkDate.getTime() === eventUTCDate.getTime();
          } catch {
              return false;
          }
      });
  };

  const isSelectedDay = (day) => {
    if (!selectedDate) return false;
    return selectedDate.getUTCDate() === day &&
           selectedDate.getUTCMonth() === month &&
           selectedDate.getUTCFullYear() === year;
  }

  const days = [];
  for (let i = 0; i < firstDayOfMonth; i++) {
    days.push(<div key={`empty-${i}`} className="p-2 h-10 w-10"></div>);
  }
  for (let day = 1; day <= daysInMonth; day++) {
    const isEvent = isEventDay(day);
    const isCurrent = isToday(day);
    const isSelected = isSelectedDay(day);

    let dayClass = 'p-2 flex items-center justify-center h-10 w-10 rounded-full cursor-pointer transition-colors duration-200';
    if (isEvent) {
      dayClass += ' bg-amber-500 text-white font-bold';
    } else if (isCurrent) {
      dayClass += ' bg-amber-200 dark:bg-amber-500/30 text-amber-900 dark:text-amber-300 font-bold';
    } else {
      dayClass += ' text-gray-700 dark:text-slate-300 hover:bg-amber-100 dark:hover:bg-slate-700';
    }
    if (isSelected) {
      dayClass += ' ring-2 ring-blue-500 ring-offset-1';
    }

    days.push(
      <button
        key={day}
        onClick={() => onDateClick(new Date(Date.UTC(year, month, day)))}
        className={dayClass}
      >
        {day}
      </button>
    );
  }

  const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

  return (
    <div>
      <div className="flex justify-between items-center mb-4">
        <button onClick={handlePrevMonth} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors">&larr;</button>
        <div className="font-bold text-lg text-amber-800 dark:text-amber-400">{`${monthName} ${year}`}</div>
        <button onClick={handleNextMonth} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-600 transition-colors">&rarr;</button>
      </div>
      <div className="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-500 dark:text-slate-400">
        {weekdays.map(day => <div key={day} className="py-2">{day}</div>)}
      </div>
      <div className="grid grid-cols-7 gap-1 mt-2 justify-items-center">
        {days}
      </div>
    </div>
  );
};


// --- From components/Header.tsx ---
const Header = ({ projectName, onProjectNameChange, onSaveAsPdf, appTitle, onAppTitleChange, onReset }) => {
    return (
        <header className="mb-6">
            <div className="flex justify-between items-start">
                <div>
                    <EditableField
                        as="h1"
                        initialValue={appTitle}
                        onSave={onAppTitleChange}
                        className="text-3xl md:text-4xl font-bold text-amber-900 dark:text-amber-400"
                        inputClassName="text-3xl md:text-4xl font-bold"
                    />
                    <div className="text-xl text-gray-700 dark:text-slate-300 mt-1 flex items-center">
                        <span className="whitespace-nowrap">專案：</span>
                        <EditableField 
                            as="span"
                            initialValue={projectName}
                            onSave={onProjectNameChange}
                            className="font-semibold ml-1"
                            inputClassName="text-xl"
                        />
                    </div>
                </div>
                <div className="flex items-start space-x-2">
                    <button
                        onClick={onReset}
                        className="no-print group mt-1 p-2.5 rounded-xl border border-gray-300/80 dark:border-slate-600 bg-gray-200/60 dark:bg-slate-700 shadow-sm hover:bg-gray-200 dark:hover:bg-slate-600 active:shadow-inner transition-all duration-200"
                        title="Reset Data"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-slate-300 transition-colors group-hover:text-gray-800 dark:group-hover:text-slate-100" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1.5">
                           <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.182-3.182m0-11.667a8.25 8.25 0 00-11.667 0L2.985 7.982" />
                        </svg>
                    </button>
                    <button
                        onClick={onSaveAsPdf}
                        className="no-print group mt-1 p-2.5 rounded-xl border border-gray-300/80 dark:border-slate-600 bg-gray-200/60 dark:bg-slate-700 shadow-sm hover:bg-gray-200 dark:hover:bg-slate-600 active:shadow-inner transition-all duration-200"
                        title="Save as PDF"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-slate-300 transition-colors group-hover:text-gray-800 dark:group-hover:text-slate-100" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1.5">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>
    );
};


// --- From components/Tabs.tsx ---
const Tabs = ({ tabs, activeTab, onTabClick }) => {
  return (
    <nav className="flex border-b border-amber-200 dark:border-slate-700 mb-6 space-x-4 md:space-x-8 no-print">
      {tabs.map(tab => (
        <button
          key={tab}
          onClick={() => onTabClick(tab)}
          className={`py-3 px-1 md:px-4 text-gray-600 dark:text-slate-400 hover:text-amber-700 dark:hover:text-amber-400 focus:outline-none transition-colors duration-200 ${
            activeTab === tab ? 'border-b-2 border-amber-700 dark:border-amber-500 text-amber-700 dark:text-amber-500 font-semibold' : ''
          }`}
        >
          {tab}
        </button>
      ))}
    </nav>
  );
};


// --- From components/TabContentWrapper.tsx ---
const TabContentWrapper = ({ title, children, isFirstPrintSection = false, className = '' }) => {
  return (
    <div className={`mb-10 last:mb-0 ${isFirstPrintSection ? '' : 'print:break-before-page'} ${className}`}>
      <h2 className="text-2xl font-bold text-amber-800 dark:text-amber-400 mb-4 pb-2 border-b border-amber-200 dark:border-slate-700">{title}</h2>
      {children}
    </div>
  );
};


// --- From components/AttendeesTab.tsx ---
const AttendeesTab = ({ attendees, onAttendeesChange, date, onDateChange }) => {
  return (
    <section className="space-y-6">
      <p className="text-base text-gray-700 dark:text-slate-300">
        請在此處列出本次會議的與會人員，每行一位。
      </p>
      <div className="bg-white dark:bg-slate-800/50 p-6 rounded-lg shadow-md border border-amber-100 dark:border-slate-700">
        <div className="flex justify-start items-center gap-x-8 mb-4">
            <h3 className="text-lg font-semibold text-amber-900 dark:text-amber-400">與會人員 (Attendees)</h3>
            <div className="flex items-center">
                <span className="text-gray-600 dark:text-slate-400 mr-2 whitespace-nowrap">會議日期:</span>
                <EditableField
                    type="date"
                    initialValue={date}
                    onSave={onDateChange}
                    className="font-semibold text-amber-900 dark:text-amber-400"
                />
            </div>
        </div>
        <EditableField
          as="div"
          initialValue={attendees.join('\n')}
          onSave={onAttendeesChange}
          className="mt-1 p-2 border rounded-md w-full bg-amber-50 dark:bg-slate-700/50 min-h-[200px]"
          inputClassName="p-2"
        />
      </div>
    </section>
  );
};

const formatDateToISO = (dateStr) => {
    if (!dateStr) return '';
    try {
        const d = new Date(dateStr);
        // Use UTC methods to avoid timezone shift issues
        const year = d.getUTCFullYear();
        const month = String(d.getUTCMonth() + 1).padStart(2, '0');
        const day = String(d.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    } catch {
        return '';
    }
};

// --- From components/ScheduleTimelineView.tsx ---
const ScheduleTimelineView = ({ tasks, onTaskChange, onTaskReorder, className = '' }) => {
    const { useMemo, useState } = React;
    const [dragOverInfo, setDragOverInfo] = useState({ stepId: null, position: null });

    const tasksByDate = useMemo(() => {
        if (!tasks) return {};
        return tasks.reduce((acc, task) => {
            const date = task.date;
            if (!acc[date]) {
                acc[date] = [];
            }
            acc[date].push(task);
            return acc;
        }, {});
    }, [tasks]);

    const sortedDates = useMemo(() => Object.keys(tasksByDate).sort(), [tasksByDate]);

    if (!tasks || tasks.length === 0) {
        return (
            <div className="flex items-center justify-center h-full text-gray-500 dark:text-slate-400">
                <p>No tasks scheduled. Add dates to steps in "Process Flow" tab.</p>
            </div>
        );
    }
    
    const handleDragStart = (e, stepId) => {
        e.dataTransfer.setData('stepId', stepId);
        e.dataTransfer.effectAllowed = 'move';
    };
    
    const handleDragOver = (e, targetStepId) => {
        e.preventDefault();
        const rect = e.currentTarget.getBoundingClientRect();
        const position = e.clientY > rect.top + rect.height / 2 ? 'bottom' : 'top';
        setDragOverInfo({ stepId: targetStepId, position });
    };

    const handleDragLeave = () => {
        setDragOverInfo({ stepId: null, position: null });
    };
    
    const handleDrop = (e, targetStepId, targetDate) => {
        e.preventDefault();
        const draggedStepId = e.dataTransfer.getData('stepId');
        const dropPosition = dragOverInfo.position;
        handleDragLeave();

        if (draggedStepId && draggedStepId !== targetStepId) {
            onTaskReorder(draggedStepId, targetStepId, targetDate, dropPosition);
        }
    };
    
    const handleColumnDrop = (e, date) => {
        e.preventDefault();
        const draggedStepId = e.dataTransfer.getData('stepId');
        handleDragLeave();
        
        if (draggedStepId) {
            onTaskReorder(draggedStepId, null, date, 'bottom'); // Drop at the end of the column
        }
    };
    
    const getDayOfWeek = (dateString) => {
        const date = new Date(dateString);
        return date.toLocaleDateString('zh-TW', { weekday: 'short', timeZone: 'UTC' }).replace('週', '');
    }

    return (
        <div className={`grid grid-flow-col auto-cols-fr gap-3 overflow-x-auto pb-4 ${className}`} style={{ minHeight: '300px' }}>
            {sortedDates.map(date => {
                const tasksForDate = tasksByDate[date];
                return (
                    <div 
                        key={date} 
                        className="bg-amber-100/50 dark:bg-slate-800/60 p-3 rounded-lg flex flex-col min-w-[160px] md:min-w-[180px]"
                        onDragOver={(e) => e.preventDefault()}
                        onDrop={(e) => handleColumnDrop(e, date)}
                    >
                        <div className="font-semibold text-amber-900 dark:text-amber-400 text-sm mb-1">{date}</div>
                        <div className="text-xs text-gray-500 dark:text-slate-400 mb-3">{getDayOfWeek(date)}</div>
                        <div className="space-y-2 flex-grow">
                            {tasksForDate.map(task => (
                                <div
                                    key={task.stepId}
                                    draggable
                                    onDragStart={(e) => handleDragStart(e, task.stepId)}
                                    onDragOver={(e) => handleDragOver(e, task.stepId)}
                                    onDragLeave={handleDragLeave}
                                    onDrop={(e) => handleDrop(e, task.stepId, date)}
                                    className={`relative bg-white dark:bg-slate-700 p-2.5 rounded-md shadow-sm border border-transparent cursor-move transition-all duration-200`}
                                >
                                    {dragOverInfo.stepId === task.stepId && dragOverInfo.position === 'top' && <div className="absolute -top-1 left-0 w-full h-1 bg-blue-500 rounded-full" />}
                                    <EditableField
                                        as="div"
                                        initialValue={task.task}
                                        onSave={(newValue) => onTaskChange(task.stepId, 'name', newValue)}
                                        className="font-medium text-gray-800 dark:text-slate-200 text-sm"
                                        inputClassName="font-medium text-sm"
                                    />
                                    <EditableField
                                        as="div"
                                        initialValue={`${task.startTime} - ${task.endTime}`}
                                        onSave={(newValue) => {
                                            const [start, end] = newValue.split(' - ');
                                            onTaskChange(task.stepId, 'time', { startTime: start?.trim(), endTime: end?.trim() });
                                        }}
                                        className="text-xs text-gray-500 dark:text-slate-400 mt-1"
                                        inputClassName="text-xs"
                                    />
                                    {dragOverInfo.stepId === task.stepId && dragOverInfo.position === 'bottom' && <div className="absolute -bottom-1 left-0 w-full h-1 bg-blue-500 rounded-full" />}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            })}
        </div>
    );
};


// --- From components/SpecsTab.tsx ---
const SpecsTab = ({ specs, onSpecChange, onAddSpec, onRemoveSpec }) => {
    return (
        <section>
            <p className="text-base text-gray-700 dark:text-slate-300 mb-6">
                請在此處定義專案的所有相關規格。您可以新增或刪除規格，並編輯其標題和細項。
            </p>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {specs.map((spec) => (
                    <div key={spec.id} className="bg-white dark:bg-slate-800/50 p-4 rounded-lg shadow-md border border-amber-100 dark:border-slate-700 relative group">
                        <button onClick={() => onRemoveSpec(spec.id)} className="absolute top-2 right-2 p-1 rounded-full bg-gray-200 dark:bg-slate-600 text-gray-600 dark:text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                        <EditableField 
                            as="h3"
                            initialValue={spec.title}
                            onSave={(newTitle) => onSpecChange(spec.id, 'title', newTitle)}
                            className="text-lg font-semibold text-amber-900 dark:text-amber-400 mb-3"
                            inputClassName="text-lg font-semibold"
                        />
                        <ul className="space-y-2">
                            {Object.entries(spec.items).map(([key, value]) => (
                                <li key={key} className="flex text-sm">
                                    <EditableField 
                                        as="span"
                                        initialValue={key}
                                        onSave={(newKey) => onSpecChange(spec.id, 'itemKey', { oldKey: key, newKey })}
                                        className="font-medium text-gray-600 dark:text-slate-400 w-2/5"
                                        inputClassName="font-medium"
                                    />
                                    <span className="mx-2">:</span>
                                    <EditableField 
                                        as="span"
                                        initialValue={value}
                                        onSave={(newValue) => onSpecChange(spec.id, 'itemValue', { key, newValue })}
                                        className="text-gray-800 dark:text-slate-200 w-3/5"
                                    />
                                </li>
                            ))}
                        </ul>
                        <button onClick={() => onSpecChange(spec.id, 'addItem')} className="mt-4 text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">+ Add Item</button>
                    </div>
                ))}
                <button onClick={onAddSpec} className="flex items-center justify-center p-4 border-2 border-dashed border-amber-300 dark:border-slate-600 rounded-lg text-amber-600 dark:text-slate-400 hover:bg-amber-100 dark:hover:bg-slate-700 transition-colors">
                    + Add New Spec
                </button>
            </div>
        </section>
    );
};


// --- From components/ProcessFlowTab.tsx ---
const ProcessFlowTab = ({ steps, onStepChange, specs, onAddStep, onRemoveStep, onStepReorder }) => {
    const { useState } = React;
    const [dragOverIndex, setDragOverIndex] = useState(null);

    const handleDragStart = (e, index) => {
        e.dataTransfer.setData('stepIndex', index);
    };

    const handleDragOver = (e, index) => {
        e.preventDefault();
        setDragOverIndex(index);
    };
    
    const handleDrop = (e, targetIndex) => {
        e.preventDefault();
        const draggedIndex = parseInt(e.dataTransfer.getData('stepIndex'), 10);
        setDragOverIndex(null);
        if (draggedIndex !== targetIndex) {
            onStepReorder(draggedIndex, targetIndex);
        }
    };
    
    const getStepColor = (index, total) => {
        if (index === 0) return 'bg-blue-500';
        if (index === total -1) return 'bg-green-500';
        const hue = 160;
        const saturation = 100;
        const lightness = 45 - (index / total) * 15;
        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    };

    return (
        <section>
            <p className="text-base text-gray-700 dark:text-slate-300 mb-6">
                拖曳步驟以重新排序流程。點擊編輯名稱、日期和關聯規格。
            </p>
            {/* Process Flow Visual */}
            <div className="flex flex-wrap items-center justify-center gap-y-2 mb-10 overflow-x-auto pb-4">
                {steps.map((step, index) => (
                    <div key={step.id} className="flex items-center">
                        <div 
                            className="flex items-center justify-center text-white font-medium text-sm px-4 py-2"
                            style={{ 
                                backgroundColor: getStepColor(index, steps.length),
                                clipPath: 'polygon(0% 0%, 85% 0, 100% 50%, 85% 100%, 0% 100%)'
                            }}
                        >
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                           <span>{step.name}</span>
                        </div>
                        {index < steps.length - 1 && <div className="-ml-4 w-4 h-full" style={{backgroundColor: getStepColor(index + 1, steps.length)}}></div>}
                    </div>
                ))}
                 <button onClick={onAddStep} className="flex items-center justify-center text-green-700 font-medium text-sm px-4 py-2 rounded-md border-2 border-dashed border-green-300 dark:border-green-600 hover:bg-green-50 dark:hover:bg-green-900/50 transition-colors ml-2">
                    Add Step +
                </button>
            </div>
            {/* Process Steps Details */}
            <div className="space-y-4">
                {steps.map((step, index) => (
                    <div 
                        key={step.id} 
                        draggable
                        onDragStart={(e) => handleDragStart(e, index)}
                        onDragOver={(e) => handleDragOver(e, index)}
                        onDragLeave={() => setDragOverIndex(null)}
                        onDrop={(e) => handleDrop(e, index)}
                        className={`p-4 bg-white dark:bg-slate-800/50 rounded-lg shadow-md border border-amber-100 dark:border-slate-700 grid grid-cols-1 md:grid-cols-10 gap-4 items-center transition-all duration-200 ${dragOverIndex === index ? 'ring-2 ring-blue-500 scale-105' : ''}`}>
                        <div className="md:col-span-2 flex items-center">
                           <span className="text-gray-400 dark:text-slate-500 mr-4 cursor-move" title="Drag to reorder">☰</span>
                           <EditableField 
                                as="span"
                                initialValue={step.name}
                                onSave={(newName) => onStepChange(step.id, 'name', newName)}
                                className="font-semibold text-amber-900 dark:text-amber-400"
                            />
                        </div>
                        <div className="md:col-span-2">
                            <label className="text-xs text-gray-500 dark:text-slate-400">Start Date</label>
                            <EditableField 
                                type="date"
                                initialValue={formatDateToISO(step.startDate)}
                                onSave={(newDate) => onStepChange(step.id, 'startDate', newDate)}
                                className="block w-full"
                            />
                        </div>
                         <div className="md:col-span-2">
                            <label className="text-xs text-gray-500 dark:text-slate-400">End Date</label>
                             <EditableField 
                                type="date"
                                initialValue={formatDateToISO(step.endDate)}
                                onSave={(newDate) => onStepChange(step.id, 'endDate', newDate)}
                                className="block w-full"
                            />
                        </div>
                        <div className="md:col-span-3">
                             <label className="text-xs text-gray-500 dark:text-slate-400">Related Spec</label>
                             <select
                                value={step.relatedSpecId || ''}
                                onChange={(e) => onStepChange(step.id, 'relatedSpecId', e.target.value)}
                                className="block w-full p-1 border rounded-md bg-amber-50 dark:bg-slate-700 border-amber-200 dark:border-slate-600 text-sm focus:ring-amber-500 focus:border-amber-500"
                            >
                                <option value="">None</option>
                                {specs.map(spec => <option key={spec.id} value={spec.id}>{spec.title}</option>)}
                             </select>
                        </div>
                        <div className="md:col-span-1 text-right">
                           <button onClick={() => onRemoveStep(step.id)} className="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400" title="Remove Step">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                           </button>
                        </div>
                    </div>
                ))}
            </div>
        </section>
    );
};

// --- App Component ---
const App = () => {
    const { useState, useEffect, useMemo, useCallback } = React;
    
    // --- State ---
    const [appTitle, setAppTitle] = useState('NPI Meeting Board');
    const [projectName, setProjectName] = useState('New Project');
    const [projectDetails, setProjectDetails] = useState({
        id: 'Enter Project ID',
        quantity: 0,
        pcbSize: '0 x 0 mm',
        targetShipDate: 'n/a'
    });
    const [specs, setSpecs] = useState([]);
    const [processSteps, setProcessSteps] = useState([]);
    const [attendees, setAttendees] = useState([]);
    const [meetingDate, setMeetingDate] = useState(new Date().toISOString().slice(0, 10));
    const [activeTab, setActiveTab] = useState('Overview');
    const [selectedDate, setSelectedDate] = useState(new Date());

    
    const initialData = {
        appTitle: 'NPI Meeting Board',
        projectName: 'My Awesome Project',
        projectDetails: { id: 'A301-202511', quantity: 5000, pcbSize: '120 x 80 mm', targetShipDate: '2025-11-28' },
        specs: [
            { id: 'spec1', title: 'SMT Spec', items: { '共零件數': 2868, '正面': 18, '背面': 2850 } },
            { id: 'spec2', title: 'DIP Spec (manual)', items: { 'Relay pin': 5064, '手焊零件': 8, '插件': 768 } },
        ],
        processSteps: [
            { id: 'step1', name: '建BOM', details: '', type: 'process', isActive: true, startDate: '2025-11-06', endDate: '2025-11-06', relatedSpecId: 'spec1' },
            { id: 'step2', name: '料到', details: '', type: 'process', isActive: true, startDate: '2025-11-10', endDate: '2025-11-10', relatedSpecId: null },
            { id: 'step3', name: 'PCB到', details: '', type: 'process', isActive: true, startDate: '2025-11-11', endDate: '2025-11-11', relatedSpecId: null },
            { id: 'step4', name: 'SMT', details: '', type: 'process', isActive: true, startDate: '2025-11-12', endDate: '2025-11-12', relatedSpecId: 'spec1' },
            { id: 'step5', name: '手焊', details: '', type: 'process', isActive: true, startDate: '2025-11-13', endDate: '2025-11-13', relatedSpecId: 'spec2' },
            { id: 'step6', name: 'QC', details: '', type: 'qc', isActive: true, startDate: '2025-11-15', endDate: '2025-11-15', relatedSpecId: null },
            { id: 'step7', name: '包裝', details: '', type: 'pack', isActive: true, startDate: '2025-11-16', endDate: '2025-11-16', relatedSpecId: null }
        ],
        attendees: ['John Doe (Project Manager)', 'Jane Smith (Engineer)', 'Peter Jones (QA)'],
        meetingDate: '2025-11-01'
    };
    
    const LOCAL_STORAGE_KEY = 'npi-meeting-board-data';

    useEffect(() => {
        try {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                setAppTitle(data.appTitle);
                setProjectName(data.projectName);
                setProjectDetails(data.projectDetails);
                setSpecs(data.specs);
                setProcessSteps(data.processSteps);
                setAttendees(data.attendees);
                setMeetingDate(data.meetingDate);
            } else {
                 handleReset(true); // Load initial data if nothing is saved
            }
        } catch (error) {
            console.error("Failed to load data from localStorage", error);
            handleReset(true);
        }
    }, []);

    useEffect(() => {
        const dataToSave = JSON.stringify({
            appTitle,
            projectName,
            projectDetails,
            specs,
            processSteps,
            attendees,
            meetingDate
        });
        localStorage.setItem(LOCAL_STORAGE_KEY, dataToSave);
    }, [appTitle, projectName, projectDetails, specs, processSteps, attendees, meetingDate]);

    const handleReset = (isInitialLoad = false) => {
        const confirmed = isInitialLoad || window.confirm("Are you sure you want to reset all data to the default sample? This cannot be undone.");
        if (confirmed) {
            setAppTitle(initialData.appTitle);
            setProjectName(initialData.projectName);
            setProjectDetails(initialData.projectDetails);
            setSpecs(initialData.specs);
            setProcessSteps(initialData.processSteps);
            setAttendees(initialData.attendees);
            setMeetingDate(initialData.meetingDate);
        }
    };
    
    // --- Handlers ---
    const handleProjectDetailChange = (key, value) => {
        setProjectDetails(prev => ({ ...prev, [key]: value }));
    };
    
    const handleSpecChange = (id, field, data) => {
        setSpecs(prevSpecs => prevSpecs.map(spec => {
            if (spec.id === id) {
                if (field === 'title') {
                    return { ...spec, title: data };
                }
                if (field === 'itemKey') {
                    const newItems = { ...spec.items };
                    const value = newItems[data.oldKey];
                    delete newItems[data.oldKey];
                    newItems[data.newKey] = value;
                    return { ...spec, items: newItems };
                }
                if (field === 'itemValue') {
                    return { ...spec, items: { ...spec.items, [data.key]: data.newValue } };
                }
                if (field === 'addItem') {
                    const newKey = `New Item ${Object.keys(spec.items).length + 1}`;
                    return { ...spec, items: { ...spec.items, [newKey]: 'value' } };
                }
            }
            return spec;
        }));
    };
    
    const handleAddSpec = () => {
        setSpecs(prev => [...prev, {
            id: `spec${Date.now()}`,
            title: 'New Spec',
            items: { 'Parameter': 'Value' }
        }]);
    };
    
    const handleRemoveSpec = (id) => {
        setSpecs(prev => prev.filter(spec => spec.id !== id));
        setProcessSteps(prev => prev.map(step => step.relatedSpecId === id ? { ...step, relatedSpecId: null } : step));
    };

    const handleStepChange = (id, field, value) => {
        setProcessSteps(prev => prev.map(step =>
            step.id === id ? { ...step, [field]: value } : step
        ));
    };
    
    const handleAddStep = () => {
        const newStep = {
            id: `step${Date.now()}`,
            name: 'New Step',
            details: '',
            type: 'process',
            isActive: true,
            startDate: new Date().toISOString().slice(0, 10),
            endDate: new Date().toISOString().slice(0, 10),
            relatedSpecId: null
        };
        setProcessSteps(prev => [...prev, newStep]);
    };
    
    const handleRemoveStep = (id) => {
        setProcessSteps(prev => prev.filter(step => step.id !== id));
    };

    const handleStepReorder = (draggedIndex, targetIndex) => {
        setProcessSteps(prevSteps => {
            const newSteps = [...prevSteps];
            const [draggedItem] = newSteps.splice(draggedIndex, 1);
            newSteps.splice(targetIndex, 0, draggedItem);
            return newSteps;
        });
    };
    
    const handleTaskChange = (stepId, field, value) => {
        setProcessSteps(prevSteps => prevSteps.map(step => {
            if (step.id === stepId) {
                if (field === 'name') {
                    return { ...step, name: value };
                }
                if (field === 'time') {
                    // This is a placeholder as the app doesn't store specific times yet.
                    return step;
                }
            }
            return step;
        }));
    };

    const handleTaskReorder = useCallback((draggedStepId, targetStepId, targetDate, dropPosition) => {
        setProcessSteps(prevSteps => {
            let steps = [...prevSteps];
            const draggedIndex = steps.findIndex(s => s.id === draggedStepId);
            if (draggedIndex === -1) return prevSteps;

            const [draggedStep] = steps.splice(draggedIndex, 1);
            
            // Update the date of the moved step
            const duration = new Date(draggedStep.endDate).getTime() - new Date(draggedStep.startDate).getTime();
            draggedStep.startDate = targetDate;
            draggedStep.endDate = new Date(new Date(targetDate).getTime() + duration).toISOString().slice(0,10);

            steps.push(draggedStep); // Add it to the end temporarily

            // Re-sort the entire array chronologically to fix the sequence
            return steps.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
        });
    }, []);

    const scheduleTasks = useMemo(() => {
        return processSteps
            .filter(step => step.startDate)
            .map(step => ({
                id: step.id,
                stepId: step.id,
                date: formatDateToISO(step.startDate),
                task: step.name,
                startTime: '09:00', // These could be enhanced later
                endTime: '17:00',
                relatedSpec: specs.find(s => s.id === step.relatedSpecId)
            }))
            .sort((a, b) => new Date(a.date) - new Date(b.date));
    }, [processSteps, specs]);

    const activeRelatedSpecs = useMemo(() => {
      const activeSpecIds = new Set(processSteps.map(step => step.relatedSpecId).filter(Boolean));
      return specs.filter(spec => activeSpecIds.has(spec.id));
    }, [processSteps, specs]);

    const handleSaveAsPdf = () => {
        window.print();
    };
    
    const tabs = ['Overview', 'Specs', 'Process Flow', 'Attendees'];
    
    const renderTabContent = (tabOverride) => {
        const tabToRender = tabOverride || activeTab;
        switch (tabToRender) {
            case 'Specs':
                return <SpecsTab specs={specs} onSpecChange={handleSpecChange} onAddSpec={handleAddSpec} onRemoveSpec={handleRemoveSpec} />;
            case 'Process Flow':
                return <ProcessFlowTab steps={processSteps} onStepChange={handleStepChange} specs={specs} onAddStep={handleAddStep} onRemoveStep={handleRemoveStep} onStepReorder={handleStepReorder} />;
            case 'Attendees':
                return <AttendeesTab attendees={attendees} onAttendeesChange={(val) => setAttendees(val.split('\n'))} date={meetingDate} onDateChange={setMeetingDate} />;
            case 'Overview':
            default:
                return (
                    <div>
                        {/* Project Details Cards */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                           <Card title="專案 ID"><EditableField initialValue={projectDetails.id} onSave={(val) => handleProjectDetailChange('id', val)} className="text-xl font-semibold" /></Card>
                           <Card title="總訂單量"><EditableField initialValue={projectDetails.quantity} onSave={(val) => handleProjectDetailChange('quantity', parseInt(val, 10) || 0)} className="text-xl font-semibold" /> pcs</Card>
                           <Card title="PCB尺寸(mm)"><EditableField initialValue={projectDetails.pcbSize} onSave={(val) => handleProjectDetailChange('pcbSize', val)} className="text-xl font-semibold" /></Card>
                           <Card title="目標出貨日"><EditableField type="date" initialValue={projectDetails.targetShipDate} onSave={(val) => handleProjectDetailChange('targetShipDate', val)} className="text-xl font-semibold" /></Card>
                        </div>
                         {/* Process Flow Visual */}
                         <div className="flex flex-wrap items-center justify-center gap-y-2 mb-10 overflow-x-auto pb-4">
                            {processSteps.map((step, index) => (
                                <div key={step.id} className="flex items-center">
                                    <div 
                                        className="flex items-center justify-center text-white font-medium text-sm px-4 py-2"
                                        style={{ 
                                            backgroundColor: index === 0 ? '#3B82F6' : (index === processSteps.length -1 ? '#22C55E' : '#14B8A6'),
                                            clipPath: 'polygon(0% 0%, 85% 0, 100% 50%, 85% 100%, 0% 100%)'
                                        }}
                                    >
                                       <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                                       <span>{step.name}</span>
                                    </div>
                                    {index < processSteps.length - 1 && <div className="-ml-4 w-4 h-full" style={{backgroundColor: '#14B8A6'}}></div>}
                                </div>
                            ))}
                        </div>
                        {/* Main Content */}
                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            {/* Related Specs */}
                            <div className="lg:col-span-1 space-y-4">
                               <h3 className="text-lg font-semibold text-amber-800 dark:text-amber-400">Related Specs</h3>
                               {activeRelatedSpecs.length > 0 ? activeRelatedSpecs.map(spec => (
                                   <div key={spec.id} className="bg-white dark:bg-slate-800/50 p-3 rounded-lg shadow-sm border border-amber-100 dark:border-slate-700">
                                       <EditableField as="h4" initialValue={spec.title} onSave={(val) => handleSpecChange(spec.id, 'title', val)} className="font-semibold text-amber-900 dark:text-amber-400 mb-2 text-sm" />
                                       <ul className="space-y-1">
                                           {Object.entries(spec.items).map(([key, value]) => (
                                               <li key={key} className="flex text-xs">
                                                   <EditableField as="span" initialValue={key} onSave={(newKey) => handleSpecChange(spec.id, 'itemKey', { oldKey: key, newKey })} className="font-medium text-gray-500 dark:text-slate-400 w-2/5 truncate" />
                                                   <span className="mx-1">:</span>
                                                   <EditableField as="span" initialValue={value} onSave={(newValue) => handleSpecChange(spec.id, 'itemValue', { key, newValue })} className="text-gray-700 dark:text-slate-300 w-3/5" />
                                               </li>
                                           ))}
                                       </ul>
                                   </div>
                               )) : <p className="text-sm text-gray-500 dark:text-slate-400">No specs are currently linked to any process steps.</p>}
                            </div>
                            {/* Schedule Timeline */}
                            <div className="lg:col-span-3">
                                <h3 className="text-lg font-semibold text-amber-800 dark:text-amber-400 mb-4">Schedule Timeline</h3>
                                <ScheduleTimelineView tasks={scheduleTasks} onTaskChange={handleTaskChange} onTaskReorder={handleTaskReorder} />
                            </div>
                        </div>
                    </div>
                );
        }
    };
    
    // --- Print Layout ---
    const OverviewPrintContent = () => (
        <div>
            {/* Project Details Cards (Read-only for print) */}
            <div className="grid grid-cols-2 gap-4 mb-8">
               <Card title="專案 ID"><span className="text-lg font-semibold">{projectDetails.id}</span></Card>
               <Card title="總訂單量"><span className="text-lg font-semibold">{projectDetails.quantity}</span> pcs</Card>
               <Card title="PCB尺寸(mm)"><span className="text-lg font-semibold">{projectDetails.pcbSize}</span></Card>
               <Card title="目標出貨日"><span className="text-lg font-semibold">{projectDetails.targetShipDate}</span></Card>
            </div>
            {/* Schedule Timeline (Read-only for print) */}
            <div>
                <h3 className="text-lg font-semibold text-amber-800 dark:text-amber-400 mb-4">Schedule Timeline</h3>
                <ScheduleTimelineView tasks={scheduleTasks} onTaskChange={()=>{}} onTaskReorder={()=>{}} />
            </div>
        </div>
    );
    
    const PrintLayout = () => (
        <div className="hidden print:block">
            {/* Page 1: Overview */}
            <div className="print-container">
                 <TabContentWrapper title={`Overview: ${projectName}`} isFirstPrintSection={true}>
                    <OverviewPrintContent />
                 </TabContentWrapper>
            </div>
            {/* Page 2: Attendees */}
            <div className="print-container">
                <TabContentWrapper title="Attendees">
                    <AttendeesTab attendees={attendees} onAttendeesChange={()=>{}} date={meetingDate} onDateChange={()=>{}} />
                </TabContentWrapper>
            </div>
        </div>
    );
    
    return (
        <React.Fragment>
            <div className="flex flex-col md:flex-row max-w-screen-2xl mx-auto p-4 sm:p-6 gap-6">
                <aside className="w-full md:w-1/3 lg:w-1/4 xl:w-1/5 no-print">
                    <div className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-lg border border-amber-100 dark:border-slate-700">
                         <h2 className="text-lg font-bold text-amber-800 dark:text-amber-400 mb-4 pb-2 border-b border-amber-200 dark:border-slate-600">專案日曆 (Project Calendar):</h2>
                         <Calendar 
                            events={processSteps}
                            onDateClick={setSelectedDate}
                            selectedDate={selectedDate}
                         />
                    </div>
                </aside>

                <main className="w-full md:w-2/3 lg:w-3/4 xl:w-4/5">
                    <Header 
                        appTitle={appTitle} onAppTitleChange={setAppTitle}
                        projectName={projectName} onProjectNameChange={setProjectName} 
                        onSaveAsPdf={handleSaveAsPdf}
                        onReset={handleReset}
                    />
                    <Tabs tabs={tabs} activeTab={activeTab} onTabClick={setActiveTab} />
                    <div className="mt-6">
                        {renderTabContent()}
                    </div>
                </main>
            </div>
            <PrintLayout />
        </React.Fragment>
    );
};

// --- Render App ---
const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(<App />);

// --- PWA Service Worker Registration ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      })
      .catch(err => {
        console.log('ServiceWorker registration failed: ', err);
      });
  });
}
    </script>
</body>
</html>
