<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPI Meeting Board</title>
    <meta name="description" content="A web application that visualizes the New Product Introduction (NPI) plan from a whiteboard.">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#FEFCE8">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone (for TSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom print styles to ensure proper rendering */
        @media print {
          body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            background: #fff !important;
            color: #000 !important;
            font-size: 10pt;
            margin: 0;
            padding: 0;
          }
          .no-print {
            display: none !important;
          }
           .print-only {
            display: block !important;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            background: #fff;
            z-index: 9999;
          }
          .print-container {
            box-shadow: none !important;
            border: none !important;
            padding: 1cm !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            backdrop-filter: none !important;
            background: transparent !important;
            border-radius: 0 !important;
          }
          .shadow-md, .shadow-lg, .shadow-inner {
            box-shadow: none !important;
          }
          .border, .border-b, .border-amber-100, .border-amber-200 {
            border-color: #ccc !important;
          }
          .print-break-before-page {
            break-before: page;
            page-break-before: always;
          }
          .print-break-inside-avoid {
            break-inside: avoid;
            page-break-inside: avoid;
          }
          h1, h2, h3, h4 {
            color: #000 !important;
          }
          h2 {
            font-size: 16pt;
            border-color: #ccc !important;
          }
          h3 {
            font-size: 11pt;
          }
          p, li, td, th, span {
            font-size: 9pt;
          }
          .print-card {
            box-shadow: none !important;
            border: 1px solid #ccc !important;
            background: #fff !important;
            padding: 0.5rem !important;
          }
        }
        .print-only {
           display: none;
        }
    </style>
</head>
<body class="bg-amber-50 text-gray-900 dark:bg-slate-900 dark:text-slate-200 font-sans">
    <div id="root"></div>
    <div id="print-root" class="print-only"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
// --- From types.ts ---
interface ProjectDetails {
  id: string;
  quantity: number;
  pcbSize: string;
  targetShipDate: string;
}

interface SpecDetails {
  id: string;
  title: string;
  items: Record<string, string | number>;
}

interface ProcessStep {
  id:string;
  name:string;
  details: string;
  type: 'process' | 'test' | 'qc' | 'pack';
  isActive: boolean;
  startDate: string;
  endDate: string;
  relatedSpecId?: string | null;
}

// --- From components/EditableField.tsx ---
const EditableField = ({
  initialValue,
  onSave,
  as: Component = 'span',
  className = '',
  inputClassName = '',
  type = 'text',
}) => {
  const { useState, useEffect, useRef } = React;
  const [isEditing, setIsEditing] = useState(false);
  const [value, setValue] = useState(String(initialValue));
  const inputRef = useRef(null);

  useEffect(() => {
    setValue(String(initialValue));
  }, [initialValue]);

  useEffect(() => {
    if (isEditing && inputRef.current) {
      inputRef.current.focus();
      if (inputRef.current instanceof HTMLInputElement) {
        inputRef.current.select();
      }
    }
  }, [isEditing]);

  const handleSave = () => {
    if (String(initialValue) !== value) {
      onSave(value);
    }
    setIsEditing(false);
  };
  
  const isTextarea = Component === 'div' || (typeof initialValue === 'string' && initialValue.includes('\n'));

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !isTextarea && type !== 'datetime-local') {
        e.preventDefault();
        handleSave();
    } else if (e.key === 'Escape') {
      setValue(String(initialValue));
      setIsEditing(false);
    }
  };

  if (isEditing) {
    const commonProps = {
        value: value,
        onChange: (e) => setValue(e.target.value),
        onBlur: handleSave,
        onKeyDown: handleKeyDown,
        className: `w-full h-full bg-white dark:bg-slate-900 outline-none focus:ring-2 focus:ring-amber-500 dark:focus:ring-amber-600 rounded-md ${inputClassName}`
    };

    if (isTextarea) {
      return (
        <textarea
          ref={inputRef}
          {...commonProps}
          rows={Math.max(3, String(value).split('\n').length + 1)}
        />
      );
    }

    return (
      <input
        ref={inputRef}
        type={type}
        {...commonProps}
      />
    );
  }
  
  const displayValue = (type === 'datetime-local' && typeof value === 'string' && value)
    ? value.replace('T', ' ')
    : value;

  return (
    <Component
      onDoubleClick={() => setIsEditing(true)}
      className={`${className} transition-colors cursor-pointer hover:bg-amber-100/50 dark:hover:bg-amber-500/10 rounded-md p-1 -m-1`}
      title="Double-click to edit"
      style={ isTextarea ? { whiteSpace: 'pre-wrap', minHeight: '1.5em' } : {}}
    >
      {displayValue || <span className="text-gray-400 dark:text-slate-500">(empty)</span>}
    </Component>
  );
};

// --- From components/Card.tsx ---
const Card = ({ title, children, className = '' }) => {
  return (
    <div className={`bg-white dark:bg-slate-700/50 p-4 rounded-lg shadow-md border border-amber-100 dark:border-slate-600 print:break-inside-avoid ${className}`}>
      <h3 className="text-sm font-medium text-gray-500 dark:text-slate-400">{title}</h3>
      {children}
    </div>
  );
};

// --- From components/Header.tsx ---
const Header = ({ projectName, onProjectNameChange, onSaveAsPdf, appTitle, onAppTitleChange, onReset }) => {
    return (
        <header className="mb-4">
            <div className="flex justify-between items-start">
                <div>
                    <EditableField
                        as="h1"
                        initialValue={appTitle}
                        onSave={onAppTitleChange}
                        className="text-3xl md:text-4xl font-bold text-amber-900 dark:text-amber-400"
                        inputClassName="text-3xl md:text-4xl font-bold"
                    />
                    <div className="text-xl text-gray-700 dark:text-slate-300 mt-1 flex items-center">
                        <span className="whitespace-nowrap">專案：</span>
                        <EditableField 
                            as="span"
                            initialValue={projectName}
                            onSave={onProjectNameChange}
                            className="font-semibold ml-1"
                            inputClassName="text-xl"
                        />
                    </div>
                </div>
                <div className="flex items-start space-x-2">
                    <button
                        onClick={onReset}
                        className="no-print group mt-1 p-2.5 rounded-xl border border-gray-300/80 dark:border-slate-600 bg-gray-200/60 dark:bg-slate-700 shadow-sm hover:bg-gray-200 dark:hover:bg-slate-600 active:shadow-inner transition-all duration-200"
                        title="Reset Data"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-slate-300 transition-colors group-hover:text-gray-800 dark:group-hover:text-slate-100" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1.5">
                           <path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.182-3.182m0-11.667a8.25 8.25 0 00-11.667 0L2.985 7.982" />
                        </svg>
                    </button>
                    <button
                        onClick={onSaveAsPdf}
                        className="no-print group mt-1 p-2.5 rounded-xl border border-gray-300/80 dark:border-slate-600 bg-gray-200/60 dark:bg-slate-700 shadow-sm hover:bg-gray-200 dark:hover:bg-slate-600 active:shadow-inner transition-all duration-200"
                        title="Save as PDF"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-600 dark:text-slate-300 transition-colors group-hover:text-gray-800 dark:group-hover:text-slate-100" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1.5">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>
    );
};

// --- From components/Tabs.tsx ---
const Tabs = ({ tabs, activeTab, onTabClick }) => {
  return (
    <nav className="flex border-b border-amber-200 dark:border-slate-700 mb-6 space-x-4 md:space-x-8 no-print">
      {tabs.map(tab => (
        <button
          key={tab}
          onClick={() => onTabClick(tab)}
          className={`py-3 px-1 md:px-4 text-gray-600 dark:text-slate-400 hover:text-amber-700 dark:hover:text-amber-400 focus:outline-none transition-colors duration-200 ${
            activeTab === tab ? 'border-b-2 border-amber-700 dark:border-amber-500 text-amber-700 dark:text-amber-500 font-semibold' : ''
          }`}
        >
          {tab}
        </button>
      ))}
    </nav>
  );
};

// --- From components/TabContentWrapper.tsx ---
const TabContentWrapper = ({ title, children, isFirstPrintSection = false, className = '' }) => {
  return (
    <div className={`mb-10 last:mb-0 ${isFirstPrintSection ? '' : 'print-break-before-page'} ${className}`}>
      <h2 className="text-2xl font-bold text-amber-800 dark:text-amber-400 mb-4 pb-2 border-b border-amber-200 dark:border-slate-700">{title}</h2>
      {children}
    </div>
  );
};

// --- From components/AttendeesTab.tsx ---
const AttendeesTab = ({ attendees, onAttendeesChange, date, onDateChange }) => {
  return (
    <section className="space-y-6">
      <p className="text-base text-gray-700 dark:text-slate-300">
        請在此處列出本次會議的與會人員，每行一位。
      </p>
      <div className="bg-white dark:bg-slate-800/50 p-6 rounded-lg shadow-md border border-amber-100 dark:border-slate-700">
        <div className="flex justify-start items-center gap-x-8 mb-4">
            <h3 className="text-lg font-semibold text-amber-900 dark:text-amber-400">與會人員 (Attendees)</h3>
            <div className="flex items-center">
                <span className="text-gray-600 dark:text-slate-400 mr-2 whitespace-nowrap">會議日期:</span>
                <EditableField
                    type="date"
                    initialValue={date}
                    onSave={onDateChange}
                    className="font-semibold text-amber-900 dark:text-amber-400"
                />
            </div>
        </div>
        <EditableField
          as="div"
          initialValue={attendees.join('\n')}
          onSave={(value) => onAttendeesChange(value.split('\n'))}
          className="mt-1 p-2 border rounded-md w-full bg-amber-50 dark:bg-slate-700/50 min-h-[200px]"
          inputClassName="p-2"
        />
      </div>
    </section>
  );
};

// --- Completed Component: ScheduleTimelineView ---
const ScheduleTimelineView = ({ tasks, onTaskChange, onTaskReorder, onTaskDateChange }) => {
    const { useMemo, useState } = React;
    const [draggedStepId, setDraggedStepId] = useState(null);

    const tasksByDate = useMemo(() => {
        if (!tasks) return {};
        const grouped = tasks.reduce((acc, task) => {
            const dateStr = new Date(task.date).toISOString().split('T')[0];
            if (!acc[dateStr]) {
                acc[dateStr] = [];
            }
            acc[dateStr].push(task);
            return acc;
        }, {});
        // Sort tasks within each day based on their process step order
        Object.keys(grouped).forEach(date => {
            grouped[date].sort((a, b) => a.order - b.order);
        });
        return grouped;
    }, [tasks]);

    const sortedDates = useMemo(() => Object.keys(tasksByDate).sort((a,b) => new Date(a) - new Date(b)), [tasksByDate]);

    const handleDragStart = (e, stepId) => {
        e.dataTransfer.setData('stepId', stepId);
        e.dataTransfer.effectAllowed = 'move';
        setDraggedStepId(stepId);
    };

    const handleDragOver = (e) => {
        e.preventDefault();
    };

    const handleDropOnDate = (e, date) => {
        e.preventDefault();
        const sourceStepId = e.dataTransfer.getData('stepId');
        if (sourceStepId) {
            onTaskDateChange(sourceStepId, date, null); // Dropping on an empty date column
        }
        setDraggedStepId(null);
    };

    const handleDropOnTask = (e, targetStepId, date) => {
        e.preventDefault();
        e.stopPropagation();
        const sourceStepId = e.dataTransfer.getData('stepId');
        if (sourceStepId && sourceStepId !== targetStepId) {
            onTaskDateChange(sourceStepId, date, targetStepId);
        }
        setDraggedStepId(null);
    };

    const handleDragEnd = () => {
        setDraggedStepId(null);
    };

    if (!tasks || tasks.length === 0) {
        return (
            <div className="flex items-center justify-center h-full text-gray-500 dark:text-slate-400">
                <p>No tasks scheduled.</p>
            </div>
        );
    }

    const weekdays = ['日', '一', '二', '三', '四', '五', '六'];

    return (
        <div className="flex overflow-x-auto space-x-3 pb-4">
            {sortedDates.map(dateStr => {
                const date = new Date(dateStr + 'T00:00:00'); // Ensure local timezone
                const dayOfWeek = weekdays[date.getDay()];
                const tasksForDate = tasksByDate[dateStr];

                return (
                    <div
                        key={dateStr}
                        className="flex-shrink-0 w-48 bg-amber-100/50 dark:bg-slate-800/50 rounded-lg p-2 flex flex-col min-h-[300px]"
                        onDragOver={handleDragOver}
                        onDrop={(e) => handleDropOnDate(e, dateStr)}
                    >
                        <div className="font-semibold text-center pb-2 border-b border-amber-200 dark:border-slate-700">
                            <p className="text-amber-900 dark:text-amber-400">{dateStr}</p>
                            <p className="text-sm text-gray-500 dark:text-slate-400">{dayOfWeek}</p>
                        </div>
                        <div className="flex-grow space-y-1.5 pt-2">
                            {tasksForDate.map((task, index) => (
                                <div
                                    key={task.stepId}
                                    draggable
                                    onDragStart={(e) => handleDragStart(e, task.stepId)}
                                    onDragEnd={handleDragEnd}
                                    onDragOver={handleDragOver}
                                    onDrop={(e) => handleDropOnTask(e, task.stepId, dateStr)}
                                    className={`p-1.5 rounded-md shadow-sm bg-white dark:bg-slate-700 cursor-grab active:cursor-grabbing transition-opacity ${draggedStepId === task.stepId ? 'opacity-50' : 'opacity-100'}`}
                                >
                                    <EditableField
                                        initialValue={task.task}
                                        onSave={value => onTaskChange(task.stepId, { name: value })}
                                        className="font-semibold text-sm text-gray-800 dark:text-slate-200 block"
                                    />
                                    <EditableField
                                        initialValue={`${task.startTime} - ${task.endTime}`}
                                        onSave={value => {
                                            const [start, end] = value.split(/\s*-\s*/);
                                            onTaskChange(task.stepId, { startTime: start || '00:00', endTime: end || '00:00' });
                                        }}
                                        className="text-xs text-gray-500 dark:text-slate-400 block"
                                    />
                                </div>
                            ))}
                        </div>
                    </div>
                );
            })}
        </div>
    );
};

// --- New Component: SpecsTab ---
const SpecsTab = ({ specs, onSpecChange, onAddSpec, onDeleteSpec }) => {
    return (
        <section>
            <div className="flex justify-between items-center mb-4">
                 <p className="text-base text-gray-700 dark:text-slate-300">
                    管理專案的所有技術規格。雙擊任何欄位即可編輯。
                </p>
                <button
                    onClick={onAddSpec}
                    className="no-print bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors"
                >
                    Add Spec +
                </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {specs.map(spec => (
                    <div key={spec.id} className="bg-white dark:bg-slate-800/50 p-4 rounded-lg shadow-md border border-amber-100 dark:border-slate-700 relative">
                        <button
                            onClick={() => onDeleteSpec(spec.id)}
                            className="no-print absolute top-2 right-2 text-gray-400 hover:text-red-500"
                            title="Delete Spec"
                        >
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                            </svg>
                        </button>
                        <EditableField
                            as="h3"
                            initialValue={spec.title}
                            onSave={value => onSpecChange(spec.id, { title: value })}
                            className="text-lg font-bold text-amber-800 dark:text-amber-400 mb-2"
                        />
                        <ul className="space-y-1 text-sm text-gray-700 dark:text-slate-300">
                            {Object.entries(spec.items).map(([key, value]) => (
                                <li key={key} className="flex">
                                    <EditableField
                                        initialValue={key}
                                        onSave={newKey => onSpecChange(spec.id, { itemKey: { oldKey: key, newKey } })}
                                        className="font-semibold mr-2"
                                    />:
                                    <EditableField
                                        initialValue={value}
                                        onSave={newValue => onSpecChange(spec.id, { itemValue: { key, newValue } })}
                                        className="ml-2 flex-grow"
                                    />
                                </li>
                            ))}
                        </ul>
                    </div>
                ))}
            </div>
        </section>
    );
};

// --- New Component: ProcessFlowTab ---
const ProcessFlowTab = ({ steps, specs, onStepChange, onAddStep, onDeleteStep, onStepReorder }) => {
    // Basic drag and drop for reordering
    const handleDragStart = (e, id) => e.dataTransfer.setData('stepId', id);
    const handleDragOver = (e) => e.preventDefault();
    const handleDrop = (e, targetId) => {
        const sourceId = e.dataTransfer.getData('stepId');
        onStepReorder(sourceId, targetId);
    };

    return (
        <section>
            <div className="flex justify-between items-center mb-4">
                 <p className="text-base text-gray-700 dark:text-slate-300">
                    定義、排序和排程製造流程中的每個步驟。
                </p>
                <button
                    onClick={onAddStep}
                    className="no-print bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors"
                >
                    Add Step +
                </button>
            </div>
            <div className="bg-white dark:bg-slate-800/50 p-4 rounded-lg shadow-md border border-amber-100 dark:border-slate-700">
                <div className="hidden md:grid grid-cols-12 gap-4 font-semibold text-sm text-gray-500 dark:text-slate-400 px-4 py-2">
                    <div className="col-span-1">Order</div>
                    <div className="col-span-2">Step Name</div>
                    <div className="col-span-3">Details</div>
                    <div className="col-span-2">Start Date</div>
                    <div className="col-span-2">End Date</div>
                    <div className="col-span-2">Related Spec</div>
                </div>
                 <div className="space-y-2">
                    {steps.map((step, index) => (
                        <div
                            key={step.id}
                            draggable
                            onDragStart={(e) => handleDragStart(e, step.id)}
                            onDragOver={handleDragOver}
                            onDrop={(e) => handleDrop(e, step.id)}
                            className="grid grid-cols-12 gap-4 items-center p-4 rounded-lg bg-amber-50/50 dark:bg-slate-700/50 cursor-grab"
                        >
                            <div className="col-span-1 font-bold text-amber-800 dark:text-amber-400">{index + 1}</div>
                            <div className="col-span-10 md:col-span-2">
                                <EditableField initialValue={step.name} onSave={value => onStepChange(step.id, { name: value })} className="font-semibold"/>
                            </div>
                            <div className="col-span-10 md:col-span-3">
                                <EditableField initialValue={step.details} onSave={value => onStepChange(step.id, { details: value })} />
                            </div>
                            <div className="col-span-10 md:col-span-2">
                                <EditableField type="date" initialValue={step.startDate} onSave={value => onStepChange(step.id, { startDate: value })} />
                            </div>
                            <div className="col-span-10 md:col-span-2">
                                 <EditableField type="date" initialValue={step.endDate} onSave={value => onStepChange(step.id, { endDate: value })} />
                            </div>
                            <div className="col-span-10 md:col-span-2">
                                <select
                                    value={step.relatedSpecId || ''}
                                    onChange={(e) => onStepChange(step.id, { relatedSpecId: e.target.value })}
                                    className="w-full bg-white dark:bg-slate-600 p-2 rounded-md border border-gray-300 dark:border-slate-500"
                                >
                                    <option value="">None</option>
                                    {specs.map(spec => <option key={spec.id} value={spec.id}>{spec.title}</option>)}
                                </select>
                            </div>
                             <div className="col-span-1 justify-self-end">
                                <button onClick={() => onDeleteStep(step.id)} className="text-gray-400 hover:text-red-500" title="Delete Step">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    ))}
                 </div>
            </div>
        </section>
    );
};

// --- New Component: OverviewTab ---
const OverviewTab = ({ projectDetails, onProjectDetailsChange, processSteps, specs, scheduleTasks, onTaskChange, onTaskDateChange }) => {
    
    const relatedSpecs = React.useMemo(() => {
        const specIdsInUse = new Set(processSteps.map(step => step.relatedSpecId).filter(Boolean));
        return specs.filter(spec => specIdsInUse.has(spec.id));
    }, [processSteps, specs]);
    
    // Process Flow visualization component
    const ProcessFlowVisual = ({ steps }) => {
        return (
            <div className="overflow-x-auto whitespace-nowrap p-4 bg-white dark:bg-slate-800/50 rounded-lg shadow-md border border-amber-100 dark:border-slate-700 my-4">
                <div className="flex items-center">
                    {steps.map((step, index) => {
                        const isFirst = index === 0;
                        const isLast = index === steps.length - 1;
                        let colorClass = 'bg-teal-500';
                        if (isFirst) colorClass = 'bg-blue-500';
                        if (isLast) colorClass = 'bg-green-500';

                        return (
                           <div key={step.id} className={`flex items-center text-white font-semibold text-sm h-10 ${!isFirst ? '-ml-4' : ''}`}>
                               <div className={`relative px-6 py-2 ${colorClass}`} style={{ clipPath: 'polygon(0 0, calc(100% - 16px) 0, 100% 50%, calc(100% - 16px) 100%, 0 100%, 16px 50%)' }}>
                                   <span className="mr-2">✓</span> {step.name}
                               </div>
                           </div>
                        );
                    })}
                </div>
            </div>
        );
    };

    return (
        <section>
             <p className="text-sm text-gray-700 dark:text-slate-300 -mt-4 mb-4">
               此處顯示了 Enter Project ID NPI 試產的關鍵資訊。您可以從此處查看專案的整體概況、相關規格文件、使用下方時間軸來深入了解每個流程的日期。每個流程階段的規格文件均已在此處顯示。
             </p>
             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                 <Card title="專案編號"><EditableField initialValue={projectDetails.id} onSave={value => onProjectDetailsChange('id', value)} className="text-xl font-bold text-amber-900 dark:text-amber-400" /></Card>
                 <Card title="試產數量"><EditableField initialValue={projectDetails.quantity} onSave={value => onProjectDetailsChange('quantity', Number(value))} className="text-xl font-bold text-amber-900 dark:text-amber-400" /> pcs</Card>
                 <Card title="PCB 尺寸 (mm)"><EditableField initialValue={projectDetails.pcbSize} onSave={value => onProjectDetailsChange('pcbSize', value)} className="text-xl font-bold text-amber-900 dark:text-amber-400" /></Card>
                 <Card title="目標出貨日"><EditableField type="date" initialValue={projectDetails.targetShipDate} onSave={value => onProjectDetailsChange('targetShipDate', value)} className="text-xl font-bold text-amber-900 dark:text-amber-400" /></Card>
             </div>

             <ProcessFlowVisual steps={processSteps} />

             <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 mt-6">
                 <div className="lg:col-span-1">
                     <h3 className="text-xl font-bold text-amber-800 dark:text-amber-400 mb-2">Related Specs</h3>
                     <div className="space-y-4">
                        {relatedSpecs.map(spec => (
                           <div key={spec.id} className="bg-white dark:bg-slate-800/50 p-3 rounded-lg shadow-md border border-amber-100 dark:border-slate-700">
                             <h4 className="font-bold text-amber-800 dark:text-amber-400">{spec.title}</h4>
                              <ul className="text-sm list-disc list-inside text-gray-600 dark:text-slate-300">
                                {Object.entries(spec.items).map(([key, value]) => (
                                    <li key={key}><span className="font-semibold">{key}:</span> {value}</li>
                                ))}
                              </ul>
                           </div>
                        ))}
                     </div>
                 </div>
                 <div className="lg:col-span-3">
                     <h3 className="text-xl font-bold text-amber-800 dark:text-amber-400 mb-2">Schedule Timeline</h3>
                     <div className="h-[75vh]">
                        <ScheduleTimelineView tasks={scheduleTasks} onTaskChange={onTaskChange} onTaskDateChange={onTaskDateChange} />
                     </div>
                 </div>
             </div>
        </section>
    )
}

// --- App Component ---
const App = () => {
  const { useState, useEffect, useMemo, useCallback } = React;
  
  const useLocalStorage = (key, initialValue) => {
    const [storedValue, setStoredValue] = useState(() => {
      try {
        const item = window.localStorage.getItem(key);
        return item ? JSON.parse(item) : initialValue;
      } catch (error) {
        console.error(error);
        return initialValue;
      }
    });

    const setValue = (value) => {
      try {
        const valueToStore = value instanceof Function ? value(storedValue) : value;
        setStoredValue(valueToStore);
        window.localStorage.setItem(key, JSON.stringify(valueToStore));
      } catch (error) {
        console.error(error);
      }
    };
    return [storedValue, setValue];
  };

  const initialData = {
      appName: 'NPI Meeting Board',
      projectName: 'New Project',
      projectDetails: { id: 'Enter Project ID', quantity: 0, pcbSize: '0 x 0 x 0 mm', targetShipDate: '' },
      specs: [
          { id: 'spec-1', title: 'SMT Spec', items: { 'Total units': 'Enter details here', 'Top side': 'Enter details here', 'Bottom side': 'Enter details here' }},
          { id: 'spec-2', title: 'DIP Spec (manual)', items: { 'Relay pin': 'Enter details here', '手焊零件': 'Enter value', '插件': 'New Value' }},
          { id: 'spec-3', title: 'PCB Spec', items: { 'Layers Count': 'Enter value', 'Material': 'e.g. FR-4', 'Thickness': 'e.g. 1.6mm', 'Surface Finish': 'e.g. ENIG' }},
          { id: 'spec-4', title: 'Packaging Spec', items: { 'Box Type': 'e.g. Corrugated', 'Labeling Standard': 'Enter details', 'Units per Box': 'Enter number' }},
      ],
      processSteps: [
         { id: 'step-1', name: '建BOM', details: 'Bill of Materials creation and finalization.', type: 'process', isActive: true, startDate: '2025-11-03', endDate: '2025-11-04', relatedSpecId: 'spec-1' },
         { id: 'step-2', name: '料到', details: 'Receiving and incoming inspection of all components.', type: 'process', isActive: true, startDate: '2025-11-05', endDate: '2025-11-05', relatedSpecId: null },
         { id: 'step-3', name: 'PCB到', details: 'Receiving and incoming inspection of bare PCBs.', type: 'process', isActive: true, startDate: '2025-11-07', endDate: '2025-11-07', relatedSpecId: 'spec-3' },
         { id: 'step-4', name: 'SMT', details: 'Surface Mount Technology assembly process.', type: 'process', isActive: true, startDate: '2025-11-11', endDate: '2025-11-12', relatedSpecId: 'spec-1' },
      ],
      attendees: [],
      meetingDate: new Date().toISOString().split('T')[0],
      activeTab: 'Overview'
  };

  const [appName, setAppName] = useLocalStorage('npi_appName', initialData.appName);
  const [projectName, setProjectName] = useLocalStorage('npi_projectName', initialData.projectName);
  const [projectDetails, setProjectDetails] = useLocalStorage('npi_projectDetails', initialData.projectDetails);
  const [specs, setSpecs] = useLocalStorage('npi_specs', initialData.specs);
  const [processSteps, setProcessSteps] = useLocalStorage('npi_processSteps', initialData.processSteps);
  const [attendees, setAttendees] = useLocalStorage('npi_attendees', initialData.attendees);
  const [meetingDate, setMeetingDate] = useLocalStorage('npi_meetingDate', initialData.meetingDate);
  const [activeTab, setActiveTab] = useState(initialData.activeTab);

  const handleReset = () => {
      if (window.confirm('Are you sure you want to reset all data? This cannot be undone.')) {
          localStorage.removeItem('npi_appName');
          localStorage.removeItem('npi_projectName');
          localStorage.removeItem('npi_projectDetails');
          localStorage.removeItem('npi_specs');
          localStorage.removeItem('npi_processSteps');
          localStorage.removeItem('npi_attendees');
          localStorage.removeItem('npi_meetingDate');
          window.location.reload();
      }
  };
  
  const handleProjectDetailsChange = (key, value) => {
    setProjectDetails(prev => ({ ...prev, [key]: value }));
  };

  const handleSpecChange = (id, change) => {
    setSpecs(prev => prev.map(spec => {
      if (spec.id === id) {
        if ('title' in change) return { ...spec, title: change.title };
        if ('itemKey' in change) {
          const { oldKey, newKey } = change.itemKey;
          const newItems = { ...spec.items };
          newItems[newKey] = newItems[oldKey];
          delete newItems[oldKey];
          return { ...spec, items: newItems };
        }
        if ('itemValue' in change) {
          return { ...spec, items: { ...spec.items, [change.itemValue.key]: change.itemValue.newValue } };
        }
      }
      return spec;
    }));
  };

  const handleAddSpec = () => {
    const newId = `spec-${Date.now()}`;
    setSpecs(prev => [...prev, { id: newId, title: 'New Spec', items: { 'New Key': 'New Value' } }]);
  };

  const onDeleteSpec = (id) => {
    if (window.confirm('Are you sure you want to delete this specification?')) {
        setSpecs(prev => prev.filter(s => s.id !== id));
        setProcessSteps(prev => prev.map(step => step.relatedSpecId === id ? {...step, relatedSpecId: null} : step));
    }
  };

  const handleStepChange = (id, changes) => {
    setProcessSteps(prev => prev.map(step => step.id === id ? { ...step, ...changes } : step));
  };
  
   const handleStepReorder = (sourceId, targetId) => {
    setProcessSteps(prev => {
        const sourceIndex = prev.findIndex(s => s.id === sourceId);
        const targetIndex = prev.findIndex(s => s.id === targetId);
        if (sourceIndex === -1 || targetIndex === -1) return prev;
        const newSteps = [...prev];
        const [movedStep] = newSteps.splice(sourceIndex, 1);
        newSteps.splice(targetIndex, 0, movedStep);
        return newSteps;
    });
  };


  const handleAddStep = () => {
    const newId = `step-${Date.now()}`;
    const today = new Date().toISOString().split('T')[0];
    setProcessSteps(prev => [...prev, { id: newId, name: 'New Step', details: '', type: 'process', isActive: true, startDate: today, endDate: today, relatedSpecId: null }]);
  };
  
  const onDeleteStep = (id) => {
    if (window.confirm('Are you sure you want to delete this step?')) {
      setProcessSteps(prev => prev.filter(s => s.id !== id));
    }
  };

  const scheduleTasks = useMemo(() => {
    return processSteps.flatMap((step, index) => {
      const startDate = new Date(step.startDate + 'T00:00:00');
      const endDate = new Date(step.endDate + 'T00:00:00');
      const tasks = [];
      let currentDate = new Date(startDate);

      while(currentDate <= endDate) {
          tasks.push({
              id: `${step.id}-${currentDate.toISOString()}`,
              stepId: step.id,
              date: currentDate.toISOString().split('T')[0],
              task: step.name,
              startTime: '09:00',
              endTime: '17:00',
              order: index
          });
          currentDate.setDate(currentDate.getDate() + 1);
      }
      return tasks;
    }).sort((a,b) => new Date(a.date) - new Date(b.date));
  }, [processSteps]);

  const handleTaskDateChange = (stepId, newDateStr, targetStepId) => {
    setProcessSteps(prevSteps => {
        const stepToMove = prevSteps.find(s => s.id === stepId);
        if (!stepToMove) return prevSteps;

        // Calculate duration
        const start = new Date(stepToMove.startDate);
        const end = new Date(stepToMove.endDate);
        const duration = (end - start) / (1000 * 60 * 60 * 24);

        // Update dates
        const newStartDate = new Date(newDateStr + 'T00:00:00');
        const newEndDate = new Date(newStartDate);
        newEndDate.setDate(newStartDate.getDate() + duration);

        const updatedStep = {
            ...stepToMove,
            startDate: newStartDate.toISOString().split('T')[0],
            endDate: newEndDate.toISOString().split('T')[0],
        };

        let reorderedSteps = prevSteps.map(s => s.id === stepId ? updatedStep : s);
        
        // Re-sort based on new dates
        reorderedSteps.sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
        
        return reorderedSteps;
    });
  };

  const handleSaveAsPdf = () => {
    const printRoot = document.getElementById('print-root');
    const appRoot = document.getElementById('root');
    
    // Temporarily render the print layout
    const printElement = <PrintLayout appState={{...appState, activeTab: 'Overview'}} />;
    ReactDOM.createRoot(printRoot).render(printElement);
    
    // Use a short timeout to allow React to render the print content
    setTimeout(() => {
        window.print();
        // Clean up the print root after printing
        ReactDOM.createRoot(printRoot).render(null);
    }, 100);
  };
  
  const tabs = ['Overview', 'Specs', 'Process Flow', 'Attendees'];
  const appState = {
      appName, projectName, projectDetails, specs, processSteps, attendees, meetingDate, activeTab, scheduleTasks
  };
  const handlers = {
      setAppName, setProjectName, handleProjectDetailsChange, handleSpecChange, handleAddSpec, onDeleteSpec, handleStepChange, handleAddStep, onDeleteStep, handleStepReorder, setAttendees, setMeetingDate, setActiveTab, handleTaskDateChange
  };

  return (
    <div className="p-4 md:p-8 max-w-screen-2xl mx-auto">
        <Header 
            appTitle={appName} onAppTitleChange={setAppName}
            projectName={projectName} onProjectNameChange={setProjectName}
            onSaveAsPdf={handleSaveAsPdf}
            onReset={handleReset}
        />
        <main>
            <Tabs tabs={tabs} activeTab={activeTab} onTabClick={setActiveTab} />
            <div className="tab-content">
                {activeTab === 'Overview' && <OverviewTab projectDetails={projectDetails} onProjectDetailsChange={handleProjectDetailsChange} processSteps={processSteps} specs={specs} scheduleTasks={scheduleTasks} onTaskChange={handleStepChange} onTaskDateChange={handleTaskDateChange}/>}
                {activeTab === 'Specs' && <SpecsTab specs={specs} onSpecChange={handleSpecChange} onAddSpec={handleAddSpec} onDeleteSpec={onDeleteSpec} />}
                {activeTab === 'Process Flow' && <ProcessFlowTab steps={processSteps} specs={specs} onStepChange={handleStepChange} onAddStep={handleAddStep} onDeleteStep={onDeleteStep} onStepReorder={handleStepReorder} />}
                {activeTab === 'Attendees' && <AttendeesTab attendees={attendees} onAttendeesChange={setAttendees} date={meetingDate} onDateChange={setMeetingDate}/>}
            </div>
        </main>
    </div>
  );
};


const PrintLayout = ({ appState }) => {
    const { activeTab, ...restOfState } = appState;
    return (
        <div>
            <TabContentWrapper title="專案總覽 (Overview)" isFirstPrintSection={true}>
                <OverviewTab {...restOfState} onProjectDetailsChange={() => {}} onTaskChange={() => {}} onTaskDateChange={()=>{}} />
            </TabContentWrapper>
            <TabContentWrapper title="與會人員 (Attendees)">
                <AttendeesTab attendees={appState.attendees} date={appState.meetingDate} onAttendeesChange={() => {}} onDateChange={() => {}}/>
            </TabContentWrapper>
        </div>
    );
};


const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

    </script>
</body>
</html>
